<analysis>**original_problem_statement:**
The user wants to create an application named صقر (Saqr), which is an advertisement-focused platform similar to Instagram's Reels or TikTok.

**PRODUCT REQUIREMENTS:**
-   **Core Functionality:** Users scroll through a vertical, full-screen feed of video ads, similar to TikTok/Reels.
-   **Points System:** Users earn 1 point for every full minute of ad-watching.
-   **Redemption:** 500 points can be redeemed for .
-   **Anti-cheat:** Prevent users from gaining points by watching the same ad multiple times. The system tracks watched ads per user.
-   **Authentication:**
    -   User registration via Google, Apple, and standard email/password.
    -   A single, unified login page for both regular users and admins. Admin credentials automatically redirect to the admin dashboard.
-   **Guest Mode:** Allow users to browse ads without logging in.
-   **Withdrawals:**
    -   Admin approval is required for all withdrawal requests.
    -   Supported withdrawal methods: PayPal, STC Pay, and local banks.
-   **Advertiser Features:**
    -   A section for advertisers to post ads, including a website URL.
    -   Fee for posting an ad is 500 SAR for one month.
    -   Payment gateways: Stripe (international), Tap (local), Tabby, Tamara, STC Pay, and PayPal.
    -   A Visit Website button on the ad viewer.
-   **Admin Panel:** A comprehensive dashboard for the app owner to:
    -   Manage withdrawal requests and ad submissions.
    -   View financial statistics (revenue, payouts, profit).
    -   View user statistics (total, online, offline).
    -   View ad performance analytics (completion rates, top ads).
    -   Manage invoices.
    -   Admin Login:  / .
-   **Mobile App:** A React Native mobile application with the same functionality as the web app.
-   **Localization:** The app must support both Arabic and English.
-   **Push Notifications:** Users receive notifications for key events (e.g., withdrawal status, ad approval, point milestones).

**User's preferred language**: Arabic

**what currently exists?**
The web application is nearly feature-complete. The backend (FastAPI) and frontend (React) are fully integrated.
-   **Unified Authentication:** A single login page handles both user and admin logins, with automatic redirection for admins. Google OAuth is also integrated.
-   **Ad Viewer:** The UI has been completely redesigned into a modern, full-screen, TikTok-style feed with real-time viewer counts.
-   **Admin Dashboard:** A multi-tab dashboard is fully functional, displaying live data for user stats, ad management, withdrawals, financial analytics, and invoices.
-   **Payment Gateways:** Stripe is fully integrated. Placeholders and UI elements exist for Tap, Tabby, Tamara, STC Pay, and PayPal, but their backend logic is not implemented.
-   **Push Notifications:** A complete push notification system has been implemented on the backend (using Firebase), with corresponding pages on the web and mobile apps.
-   **React Native App (/app/mobile):** A well-structured skeleton exists. Key parts like the API service and Auth screen have been updated to align with the latest backend changes, but the UI for most screens still needs to be built.

**Last working item**:
-   Last item agent was working: Adding support for new payment gateways: Tabby, Tamara, STC Pay, and PayPal, as requested by the user. The agent created placeholder backend routes, added environment variables, and updated the advertiser page UI to show these new options.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? both
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Complete New Payment Gateway Integrations
-   Issue 2: (P1) Tap Payments Integration is Incomplete
-   Issue 3: (P2) Apple OAuth Login is Not Implemented

Issues Detail:
-   **Issue 1: Complete New Payment Gateway Integrations (Tabby, Tamara, STC Pay, PayPal)**
    -   **Attempted fixes:** Placeholder backend routes were created in , and the frontend  was updated to display them. No actual payment logic was implemented.
    -   **Next debug checklist:**
        1.  Ask the user for the API keys for Tabby, Tamara, STC Pay, and PayPal.
        2.  For each gateway, use  to get the correct implementation details.
        3.  Implement the backend logic for creating checkout sessions and handling callbacks for each gateway.
        4.  Connect the frontend UI to the new backend logic.
    -   **Why fix this issue and what will be achieved with the fix?** Fulfills a direct user request and expands payment options for advertisers.
    -   **Status:** BLOCKED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** Awaiting API keys from the user.

-   **Issue 2: Tap Payments Integration is Incomplete**
    -   **Attempted fixes:** Placeholder backend routes and UI exist.
    -   **Next debug checklist:**
        1.  Obtain the  from the user.
        2.  Implement the payment logic in .
    -   **Why fix this issue and what will be achieved with the fix?** Fulfills the requirement for a key local payment gateway.
    -   **Status:** BLOCKED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** Awaiting API key from the user.

-   **Issue 3: Apple OAuth Login is Not Implemented**
    -   **Attempted fixes:** None.
    -   **Next debug checklist:**
        1.  Call  to get the playbook for Apple OAuth.
        2.  Implement the backend routes for the OAuth flow.
        3.  Add the Sign in with Apple button to  (Web) and  (Mobile).
    -   **Why fix this issue and what will be achieved with the fix?** Completes the user's original authentication requirements.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   **Task 1: Build Out React Native Mobile App** (P1)
    -   **Where to resume:** The project is structured in , and the auth flow is updated. The next step is to build the UI for the main screens (, , , ) and connect them to the existing backend APIs, ensuring a user experience consistent with the web app.
    -   **What will be achieved with this?** A functional cross-platform mobile application for both iOS and Android.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P2) **Implement Withdrawal Processing:** The backend routes and admin UI exist for approving/rejecting withdrawals, but the actual logic to trigger payments via PayPal, STC Pay, or bank transfers needs to be implemented. This will require using the respective APIs for those services.
-   **Future Tasks:**
    -   Deploy the web and backend applications to a production environment.
    -   Publish the completed mobile app to the Apple App Store and Google Play Store.

**Completed work in this session**
-   **Unified Admin/User Login:** Implemented and tested. A single endpoint  now handles both roles, redirecting admins correctly.
-   **TikTok/Reels UI Redesign:** The  component was completely rewritten to provide a modern, full-screen vertical video feed.
-   **Advanced Admin Dashboard:** The dashboard was significantly enhanced with live user statistics (total, online, offline), ad analytics, and new tabs for  and .
-   **Real-time Viewer Counts:** Implemented a system using a heartbeat API to display live viewer counts on ads.
-   **Push Notification System:** A full-featured notification system was added, including backend logic (Firebase), database models, API endpoints, and UI on both web and mobile.
-   **Future Task Implementation:** Proactively implemented backend routes and frontend pages for Invoicing and Analytics.
-   **UI Refinements:** Numerous small UI tweaks were made based on user feedback, including removing cluttered buttons from the ad viewer and controlling the display of welcome messages.

**Earlier issues found/mentioned but not fixed**
-   None.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Tailwind CSS, shadcn/ui, Axios, React Router, Sonner (for toasts)
-   **Backend:** FastAPI, Motor (async MongoDB), Pydantic, Firebase Admin SDK (for push notifications)
-   **Database:** MongoDB
-   **Authentication:** JWT, Google OAuth
-   **Real-time:** A heartbeat API endpoint is used to track online users and live ad viewers.
-   **Mobile:** React Native (Expo)

**key DB schema**
-   **users:**  (for online status)
-   **devices:**  (for push notifications)
-   **notifications:** 
-   **invoices:** 
-   **active_viewers:** (Implicitly managed) Tracks user_id per ad_id with a timestamp to determine live viewers.

**changes in tech stack**
-   Added  to the backend for push notifications.

**All files of reference**
-   : Contains the new unified  logic.
-   : The new TikTok-style component.
-   : The enhanced admin panel with multiple tabs and stats.
-   : API for tracking user presence and real-time stats.
-   : API for managing push notifications.
-   : Updated to show all new payment options.
-   : Consistently updated to reflect the latest state of the project.

**Areas that need refactoring**:
-   The component  is now obsolete and should be removed from the project to avoid confusion.
-   The payment logic in  is growing. Consider creating a dedicated  component to encapsulate the logic for handling different payment providers.

**key api endpoints**
-   : Unified login for users and admins.
-   : Used by the client to signal it is active.
-   : Provides admin stats (total/online/offline users).
-   : Provides the live viewer count for a specific ad.
-   : Registers a device for push notifications.
-   : Fetches notifications for the current user.

**Critical Info for New Agent**
-   The top priority is to complete the payment gateway integrations. This is currently **blocked** as it requires API keys from the user. You must start by asking the user to provide the keys for **Tabby, Tamara, STC Pay, PayPal, and Tap**.
-   The user is highly engaged and provides frequent, iterative feedback. Expect to work on small, rapid changes after presenting progress.
-   Once the payment gateways are addressed, the next major task is building out the UI of the React Native mobile app in .
-   The  component is redundant and should be deleted.

**documents and test reports created in this job**
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Requests adding Tabby, Tamara, STC Pay, and PayPal as payment options, with placeholder keys for now. (Agent scaffolded this).
2.  **User:** Asks for the app link. (Agent provided).
3.  **User:** Requests a major UI/UX overhaul: make the ad viewer like TikTok, and add advanced user stats (online, offline, etc.) to the admin dashboard. (Agent implemented).
4.  **User:** Refines the new ad viewer design: remove the like and comment buttons. (Agent implemented).
5.  **User:** Further refines the UI: hide the carousel dots on the side, and make the welcome message appear only once after the first login. (Agent implemented).
6.  **User:** Another refinement: add three faint dots on the side for visual balance, and ensure all viewer counts (live and in the admin panel) are based on real data from the backend. (Agent implemented).
7.  **User:** Final UI tweak: replace the Follow button with the Watching Now icon on the side of the ad. (Agent implemented).
8.  **User:** Asks for the app link again. (Agent provided).
9.  **User:** Asks how to save the application code. (Agent explained the Save to GitHub feature).
10. **User:** Asks for the app link a third time. (Agent provided).

**Project Health Check:**
-   **Broken:**
    -   None.
-   **Mocked:**
    -   Payment logic for Tap, Tabby, Tamara, STC Pay, and PayPal is mocked/non-existent.
-   **Incomplete/Scaffolded:**
    -   The React Native Mobile App () requires a full UI build-out for most screens.
    -   Apple OAuth login.
    -   The final step of processing withdrawals (e.g., calling PayPal's Payouts API).

**3rd Party Integrations**
-   **Emergent-managed Google Auth:** Working.
-   **Stripe (Payments):** Working.
-   **Firebase Admin SDK (Push Notifications):** Integrated.
-   **Tap Payments:** Planned, requires User API Key.
-   **Tabby:** Planned, requires User API Key.
-   **Tamara:** Planned, requires User API Key.
-   **STC Pay:** Planned, requires User API Key.
-   **PayPal:** Planned, requires User API Key.
-   **Apple OAuth:** Planned, not started.

**Testing status**
-   Testing agent used after significant changes: YES, for the unified auth feature.
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created:
    -   
-   Known regressions: None.

**Credentials to test flow:**
-   **Admin User:**
    -   Email: 
    -   Password: 
-   **Regular User:** Can be created via the registration form.

**What agent forgot to execute**
-   The agent did not delete the obsolete  file and its associated route in  after implementing the unified login, leaving technical debt.
-   The agent did not ask the user for the necessary API keys to complete the  (payment gateway integrations), leaving it in a blocked state for the next agent.</analysis>
