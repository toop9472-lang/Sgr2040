<analysis>**original_problem_statement:**
The user wants to create an application named صقر (Saqr), which is an advertisement-focused platform similar to Instagram's Reels or TikTok.

**PRODUCT REQUIREMENTS:**
-   **Core Functionality:** Users scroll through a vertical, full-screen feed of video ads.
-   **Points System:** Users earn points for watching ads, redeemable for cash. The conversion rate and earning rules must be configurable by the admin.
-   **AI Features:** The user requested AI-powered features for the admin (e.g., improvements, error analysis) and a user-facing AI component.
-   **UI/UX Enhancements:** A professional UI for the ad viewer, where controls hide during playback and a notification appears when a point is earned. A new professional logo was also requested and implemented.
-   **Authentication:** User registration via Google, Apple, and email/password.
-   **Admin Panel:** A comprehensive dashboard to manage withdrawals, ads, users, finances, and control all core application settings dynamically. A feature to track development requests was also added.
-   **Mobile App:** A React Native mobile application. The user has specifically requested a downloadable APK file, which was successfully built after extensive guidance.
-   **Advertiser Features:** A section for advertisers to post ads for a fee.
-   **Ad Integrations:** The ability to show real ads from networks like AdMob.
-   **Withdrawals:** Admin approval is required for all withdrawal requests.

**User's preferred language**: Arabic

**what currently exists?**
The project is a full-stack application with a FastAPI backend, a React frontend, and a React Native mobile app.
-   **Web App:** Features a comprehensive admin dashboard allowing dynamic management of payment gateways, OAuth providers, email services (Resend), a full AdMob configuration UI, a points system, PDF reports, Firebase push notifications, and a working Claude AI integration for both admin analysis and user chat. A new Development Requests page has also been added for the admin to track future work.
-   **Backend:** Supports all admin panel functionality, including APIs for AI, AdMob settings, and the new development requests feature.
-   **Mobile App:** The agent guided the user through an extensive, multi-day, local build process. After numerous failures and code adjustments, the user was finally able to build a functional APK. The current mobile code includes the login/visitor screens and the core ad-watching functionality.
-   **Integrations:**
    -   **Resend:** Fully integrated for emails.
    -   **Anthropic (Claude Sonnet 4):** Fully integrated for AI features.
    -   **Firebase Admin SDK:** Integrated for push notifications.
    -   **Google AdMob:** Fully configured on both backend and frontend. The user has provided their Publisher, App, and Ad Unit IDs, which are saved in the database. The mobile app has the necessary configuration in  but the ads will only become active after AdMob approves the user's account.

**Last working item**:
-   Last item agent was working: The agent's primary focus was an exhaustive, step-by-step guidance process to help the non-technical user build the mobile app's APK on their local machine. This was necessary due to platform limitations preventing the agent from building it directly. After numerous debugging cycles involving dependency issues, environment setup, and code simplification, the user successfully generated a working APK.
-   Status: USER VERIFICATION PENDING
-   Agent Testing Done: N
-   Which testing method agent to use? The user is testing the APK they built on their own Android device. No further testing is needed from the agent on this item.
-   User Testing Done: IN PROGRESS

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Mobile App Functionality Verification.
-   Issue 2: (P1) Backend logic for most payment gateways is missing (Tap, Tabby, Tamara, STC Pay, PayPal, Apple Pay).
-   Issue 3: (P2) Backend logic for Google & Apple OAuth is not implemented.
-   Issue 4: (P2) Potential N+1 query issue in the admin dashboard.

Issues Detail:
-   **Issue 1: Mobile App Functionality Verification.**
    -   **Attempted fixes:** The agent guided the user to successfully build a new APK after the previous one was just a splash screen. The new build contains the complete, updated mobile application code.
    -   **Next debug checklist:** The agent must ask the user to confirm that the latest APK they built is fully functional (i.e., shows the login/visitor screen, allows entry, and displays the ad viewer interface).
    -   **Why fix this issue and what will be achieved with the fix?** This confirms that the primary blocker (APK generation) is resolved and the core mobile application is usable by the user.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None.
-   **Issue 2: Backend logic for payment gateways is missing.**
    -   **Attempted fixes:** None in this session. UI and DB storage exist from previous sessions.
    -   **Next debug checklist:** Implement backend routes for each gateway to handle payments and withdrawals.
    -   **Why fix this issue and what will be achieved with the fix?** Critical for monetization (advertiser payments and user cash-outs).
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None.
-   **Issue 3: Backend logic for Google & Apple OAuth is not implemented.**
    -   **Attempted fixes:** None.
    -   **Next debug checklist:** Implement the backend routes and logic to handle the OAuth2 flow for Google and Apple sign-ins.
    -   **Why fix this issue and what will be achieved with the fix?** Fulfills a user requirement for multiple login options.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None.
-   **Issue 4: Potential N+1 query issue in the admin dashboard.**
    -   **Attempted fixes:** None.
    -   **Next debug checklist:** Analyze dashboard-related backend routes for database queries inside loops and refactor them to use aggregation pipelines.
    -   **Why fix this issue and what will be achieved with the fix?** Improves performance and prevents the admin panel from slowing down as data grows.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   **Task 1: Comprehensive UI/UX & AI Feature Enhancement**
    -   **Where to resume:** The UI and AI portions of this task are complete. The remaining work is to implement the backend logic for withdrawal processing in , which is currently a placeholder.
    -   **What will be achieved with this?** Allows the admin to approve and process user withdrawal requests, a core part of the app's monetization loop.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) **iOS App Build:** The user has requested an iPhone version. This will require guiding them through the process again, contingent on them having an Apple Developer account (9/year).
    -   (P2) **Integrate other Ad Networks:** The user expressed interest in using other ad networks like Unity Ads or AppLovin via mediation. This can be done after AdMob is fully verified and functional.
-   **Future Tasks:**
    -   Deploy the web and backend applications to a production environment.
    -   Publish the mobile app to the Apple App Store and Google Play Store.
    -   Add advanced PDF reporting for financial analytics.

**Completed work in this session**
-   **Mobile App APK Build:** Successfully guided the user through an extremely detailed and difficult local build process, resolving numerous environment, dependency, and configuration errors, resulting in a working APK.
-   **AI Features Implementation:**
    -   Added a floating AI chat button and modal for end-users (, ).
    -   Added an AI Assistant tab to the admin dashboard with analysis features ().
-   **AdMob Integration:**
    -   Created a full UI and backend system for the admin to configure Google AdMob.
    -   Saved the user's Publisher ID, App IDs, and Rewarded Ad Unit ID to the database.
    -   Updated the mobile app configuration to include these IDs.
-   **New Logo & UI:**
    -   Generated several AI logos based on user feedback (minimalist falcon silhouette).
    -   Updated the web app's auth page and all mobile app icons/splash screens with the new logo.
-   **Development Request Feature:**
    -   Created a new page in the admin dashboard () for the user to add and track future development tasks.
    -   Implemented the full backend API () for CRUD operations on these requests.
-   **Code & Dependency Stabilization:**
    -   Performed multiple rounds of simplification and cleanup on the mobile app's , , and  to enable a successful build.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: N+1 Query Problem:** The deployment agent reported a potential N+1 query issue in the admin dashboard in a previous session. This was not investigated or fixed.
    -   **Debug checklist:** Analyze the backend code for fetching dashboard statistics or user lists to identify loops that make database calls. Use database aggregation pipelines to fetch data in a single query.
    -   **Why to solve this issue and what will be achieved with this?** Prevents the admin dashboard from becoming slow or unresponsive with a large user base.
    -   **Should Test frontend/backend/both after fix:** backend
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   **Issue:** Mobile APK build failure.
-   **Recurrence count:** 2 (Blocked in the previous fork, became a major debugging task in this one).
-   **Status:** RESOLVED (by guiding the user to build locally). The underlying platform limitation remains, so any future mobile app changes will require the user to rebuild.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Tailwind CSS, shadcn/ui
-   **Backend:** FastAPI, Motor (async MongoDB)
-   **Mobile:** React Native, **Expo (EAS Build & Expo Go)**
-   **Database:** MongoDB
-   **AI:** Anthropic Claude Sonnet 4
-   **Ad-Network:** Google AdMob

**key DB schema**
-   **settings:** Document added for .
-   **dev_requests:** New collection with schema .

**changes in tech stack**
-   The mobile app's Expo SDK was temporarily upgraded to 54 and then reverted to 51 to achieve a stable build. Numerous dependencies were added, removed, and version-locked during the build debugging process.

**All files of reference**
-   
-   
-   
-   
-   
-   
-   
-   
-   

**Areas that need refactoring**:
-    and  are becoming monoliths. Each tab's content should be broken into a separate, self-contained component to improve maintainability. The agent added more tabs, making this problem worse.

**key api endpoints**
-   
-   

**Critical Info for New Agent**
-   **The user is non-technical.** All instructions for local actions (like building the app) must be extremely simple, broken down into single steps, and assume zero prior knowledge. The agent spent hundreds of messages guiding the user through the last build.
-   **The mobile APK build process is solved but fragile.** The user now knows how to build the APK on their local machine. Any changes to the mobile app's native dependencies or configuration will require you to guide the user to rebuild. Do not attempt to change mobile dependencies unless absolutely necessary.
-   The user has successfully built and installed a functional APK. Your first action should be to confirm with the user if the app is working as expected (shows login, etc.).

**documents and test reports created in this job**
-   
-    (Updated)
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Provided logs showing a yarn install v1.22.22
[1/4] Resolving packages...
success Already up-to-date.
Done in 0.12s. error and a subsequent  failure due to a missing git command.
2.  **User:** Replied with y after being told to install a missing dependency.
3.  **User:** Provided logs showing the  command failing because of a missing  plugin.
4.  **User:** Provided logs of  failing because yarn install v1.22.22
[1/4] Resolving packages...
success Already up-to-date.
Done in 0.05s. was not found.
5.  **User:** Provided logs showing the build failing because  does not exist.
6.  **User:** Asked for their AdMob client ID.
7.  **User:** Provided logs of a build failing because of a concurrency limit, as a previous build was stuck in the queue.
8.  **User:** Provided logs of the build failing in the Install dependencies phase due to an incompatible Node.js version on the build server.
9.  **User:** Provided logs showing the  command failed due to multiple lock files.
10. **User:** Stated that the build was successful but the app was showing a code screen in Expo Go. The agent clarified this is expected and the user should install the final APK.

**Project Health Check:**
-   **Broken:** None.
-   **Mocked:**
    -   Backend payment logic for most gateways (Tap, PayPal, etc.).
    -   Backend logic for Apple & Google OAuth.
    -   Payout processing logic.
-   **Incomplete/Scaffolded:**
    -   The mobile app's AdMob integration is configured but not yet displaying live ads pending account verification.

**3rd Party Integrations**
-   **Anthropic Claude Sonnet 4:** (Text Generation) Fully integrated.
-   **Stripe (Payments):** Partially integrated.
-   **Firebase Admin SDK (Push Notifications):** Integrated.
-   **Resend (Email):** Fully integrated.
-   **Google AdMob (Rewarded Ads):** Configured with user's keys. Awaiting account verification by Google.
-   **Emergent-managed Google Auth:** Configurable, backend logic pending.
-   **Other Payment Gateways:** UI exists for configuration, but backend logic is missing.

**Testing status**
-   Testing agent used after significant changes: YES (for AI features)
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: None
-   Known regressions: None

**Credentials to test flow:**
-   **Admin User:**
    -   Email: 
    -   Password: 
-   **Expo Account:**
    -   Username: 

**What agent forgot to execute**
-   The agent did not refactor the  or  components, instead adding more tabs and complexity, increasing technical debt.
-   The N+1 query issue identified in a previous fork remains unaddressed.</analysis>
