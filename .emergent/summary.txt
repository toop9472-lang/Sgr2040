<analysis>**original_problem_statement:**
The user wants to create an application named صقر (Saqr), which is an advertisement-focused platform similar to Instagram's Reels or TikTok.

**PRODUCT REQUIREMENTS:**
-   **Core Functionality:** Users scroll through a vertical, full-screen feed of video ads.
-   **Points System:** Users earn points for watching ads, redeemable for cash. The conversion rate and earning rules must be configurable by the admin. The user specified that a point should be earned after a cumulative minute of ad watching.
-   **AI Features:** The user requested AI-powered features for the admin and a user-facing AI chat component.
-   **UI/UX Enhancements:** A professional, full-screen UI for the ad viewer where controls are hidden. Swiping up/down navigates ads, and swiping left/right navigates between app sections. A professional logo. Dark/light mode.
-   **Authentication:** User registration via Google, Apple, and email/password.
-   **Admin Panel:** A comprehensive, well-organized dashboard to manage withdrawals, ads, users, finances, and control all core application settings (like rewards) dynamically.
-   **Mobile App:** A React Native mobile application that is 100% the focus. The user has explicitly requested a downloadable APK file and has no access to a computer, so the agent must perform the build. The mobile app must be identical in features and quality to the web app.
-   **Advertiser Features:** A section for advertisers to post ads for a fee.
-   **Withdrawals:** Admin approval is required for all withdrawal requests. All mock data must be removed.
-   **Security:** An anti-cheat system to detect and flag users trying to game the points system.
-   **Homepage:** The main page should not be for ads but should contain useful, engaging content for the user, like analytics, to break the monotony of ad-watching.

**User's preferred language**: Arabic

**what currently exists?**
-   **Web App:** The web application has been significantly enhanced and serves as the gold standard for features. It includes a new TikTok-style full-screen ad viewer, a new user homepage with analytics, a reorganized admin dashboard with a new rewards settings page, and a functional dark/light mode.
-   **Backend:** The FastAPI backend has been extended to support all the new frontend features. This includes new endpoints for fetching and updating rewards settings (), getting user analytics (), and a more robust points system.
-   **Mobile App:** The mobile app is the main point of failure. It has been rewritten and rebuilt multiple times, but the user is extremely dissatisfied, reporting that it looks primitive and lacks key features available on the web (working icons, AI assistant, advertiser page, Google/Apple login buttons, correct UI). The latest build (v2.2.0) was a failed attempt to address these issues.

**Last working item**:
-   Last item agent was working: The agent was attempting to fix the mobile application to match the functionality and design of the web application after the user provided extensive negative feedback on the latest APK. This involved another complete rewrite of  and initiating a new Expo build.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? both. After rebuilding the mobile app, the agent must guide the user to test the new APK. The agent should also use the testing agent on the web app to ensure no regressions were introduced.
-   User Testing Done: Y (User tested the last APK and reported it as broken and feature-incomplete).

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Mobile App is Broken and Lacks Feature Parity.
-   Issue 2: (P2) Implement Backend Logic for Payment Gateways.
-   Issue 3: (P2) N+1 Query Problem in Admin Dashboard.

Issues Detail:
-   **Issue 1: Mobile App is Broken and Lacks Feature Parity.**
    -   **Attempted fixes:** The agent has rewritten  multiple times and successfully built several APKs. However, none of them have met the user's expectations. The latest version was reported to have non-working icons, missing pages (AI assistant, advertiser), missing login options, and an incorrect UI.
    -   **Next debug checklist:**
        1.  **STOP** building new APKs immediately.
        2.  **Analyze** the web app's component structure (, , , , etc.).
        3.  **Refactor** the monolithic  into a proper component-based architecture mirroring the web app. Create separate files for each page/major component.
        4.  **Implement** all missing features one by one: Auth page with Google/Apple buttons, AI chat, Advertiser page, Profile page. Ensure navigation works correctly.
        5.  **Style** the components to be visually identical to the web version (gray icons, correct layout, etc.).
        6.  Once the code is properly structured and features are implemented, perform a new APK build.
    -   **Why fix this issue and what will be achieved with the fix?** This is the user's highest priority. The application is intended to be mobile-first, and the current mobile app is unusable and unacceptable to the user.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None.
-   **Issue 2: Implement Backend Logic for Payment Gateways.**
    -   **Attempted fixes:** None. UI and DB storage exist, but backend logic for Tap, Tabby, Tamara, STC Pay, PayPal, Apple Pay is missing.
    -   **Next debug checklist:** Implement FastAPI routes for each payment gateway to handle payment processing.
    -   **Why fix this issue and what will be achieved with the fix?** This is critical for the application's monetization strategy.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None.
-   **Issue 3: N+1 Query Problem in Admin Dashboard.**
    -   **Attempted fixes:** None in this session.
    -   **Next debug checklist:** Analyze dashboard-related routes in  for loops making individual database calls. Refactor to use efficient database aggregations or joins.
    -   **Why fix this issue and what will be achieved with the fix?** Prevents the admin dashboard from becoming slow or unresponsive as the user base and data grow.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix:** backend
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   **Task 1: Overhaul Mobile Application**
    -   **Where to resume:** Start by creating a new, component-based structure for the mobile app in the  directory, mirroring the web app's  structure.
    -   **What will be achieved with this?** A functional, high-quality mobile app that is identical to the web version, fulfilling the user's core request.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) **iOS App Build:** Guide the user through the process for creating an iOS version.
    -   (P2) **Integrate other Ad Networks:** Add support for Unity Ads or AppLovin.
-   **Future Tasks:**
    -   Deploy the web and backend applications to a production environment.
    -   Publish the mobile app to the Apple App Store and Google Play Store.
    -   Add advanced PDF reporting for financial analytics.

**Completed work in this session**
-   **Web UI Overhaul (Completed & User Approved):**
    -   Implemented a full-screen, swipeable, TikTok-style ad viewer () with advertiser info displayed on touch.
    -   Created a new engaging User Homepage () with analytics cards, replacing the old ad list.
    -   Implemented Dark/Light mode using React Context ().
    -   Cleaned up the bottom navigation to show only four essential, monochrome icons.
-   **Admin Dashboard Enhancements (Completed & User Approved):**
    -   Reorganized the  layout with tabs for better organization.
    -   Created a new  component to allow the admin to dynamically control points, watch time, and conversion rates.
-   **Backend Development (Completed):**
    -   Added new endpoints (, ) to support the rewards settings page.
    -   Added a new endpoint () to feed data to the new user homepage.
-   **Mobile App Development (Attempted, Failed User Acceptance):**
    -   Multiple attempts to build an APK for the user.
    -   The agent successfully logged into the user's Expo account and ran the build process. However, the resulting app was severely lacking in features and quality compared to the web counterpart.

**Earlier issues found/mentioned but not fixed**
-   None that aren't already listed in the pending issues.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Mobile APK build process.
-   **Recurrence count:** 3+
-   **Status:** BLOCKED. The issue has evolved beyond simple build errors. It is now a fundamental quality and feature-parity problem. The agent's approach of rewriting a single monolithic  file is not working and must be changed.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Tailwind CSS, shadcn/ui, React Context API, 
-   **Backend:** FastAPI, Motor (async MongoDB)
-   **Mobile:** React Native, Expo
-   **Database:** MongoDB
-   **AI:** Anthropic Claude
-   **Deployment:** Kubernetes, Expo EAS Build

**key DB schema**
-   **settings:** Document now stores global reward settings like , , , etc.

**changes in tech stack**
-    was added and installed in the mobile project.
-    was used for the web frontend swipe navigation.

**All files of reference**
-    (The source of the main problem; needs a total refactor)
-    (Reference for the ad viewer UI)
-    (Reference for the user homepage UI)
-    (Reference for admin UI)
-    (Reference for rewards UI)
-    (Backend for settings)
-    (Backend for user analytics)

**Areas that need refactoring**:
-   **/app/mobile/App.js:** This is CRITICAL. The monolithic file must be broken down into a component-based architecture similar to the web application to manage complexity and implement all required features correctly. This is the root cause of the user's dissatisfaction.

**key api endpoints**
-   
-   
-   
-   

**Critical Info for New Agent**
-   **The user is extremely unhappy with the mobile app.** Your absolute top priority (P0) is to fix the mobile app. Do not work on anything else until the mobile app is a perfect mirror of the web app in terms of features, UI, and quality.
-   **The current mobile app approach is failing.** Stop rewriting the single  file. You must refactor the mobile app into a proper, modern component-based structure. Look at the  directory for inspiration.
-   **The user has no computer.** You are responsible for the entire APK build process. The process is fragile and has failed multiple times due to interactive prompts. You have the user's Expo credentials.
-   **The web app is the source of truth.** The user likes the web app. Use it as a direct reference for how the mobile app should look and behave.

**documents and test reports created in this job**
-   
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
10. User confirms they have no computer to build the APK.
9.  Agent asks for Expo password.
8.  User provides Expo password.
7.  Agent initiates APK build but runs into multiple issues with interactive prompts (keystore creation).
6.  Agent eventually gets a build completed and provides a download link.
5.  **CRITICAL FEEDBACK:** User tests the APK and reports it's broken. Icons don't work, pages are missing (AI, ads), icons are the wrong color, login doesn't work, and the app feels primitive and nothing like the web version.
4.  Agent acknowledges feedback and promises to rebuild the mobile app to match the web app.
3.  Agent rewrites  and initiates another build.
2.  Agent successfully builds a new APK (v2.2.0) and provides the link.
1.  **CRITICAL FEEDBACK:** User reports the new APK is also broken. Packages are incorrect, the page is incomplete, AI doesn't work, and Google/Apple login buttons are missing. User asks to make the app identical to the web version and include a test ad.

**Project Health Check:**
-   **Broken:** The Mobile Application ().
-   **Mocked:** Backend logic for payment gateways and Apple OAuth.

**3rd Party Integrations**
-   **Anthropic Claude Sonnet 4:** (Text Generation) Integrated for admin/user chat.
-   **Stripe (Payments):** Partially integrated (UI/DB only).
-   **Firebase Admin SDK (Push Notifications):** Integrated.
-   **Resend (Email):** Fully integrated.
-   **Google AdMob (Rewarded Ads):** Configured.
-   **Emergent-managed Google Auth:** Configured, backend logic is present.

**Testing status**
-   Testing agent used after significant changes: YES (for web app changes, passed successfully)
-   Troubleshoot agent used after agent stuck in loop: NO
-   Test files created: []
-   Known regressions: The entire mobile application is a regression from the user's expectation.

**Credentials to test flow:**
-   **Admin User:**
    -   Email: 
    -   Password: 
-   **Expo Account:**
    -   Username: 
    -   Password: 

**What agent forgot to execute**
-   The agent failed to create a mobile app that meets the user's quality and feature requirements. The core mistake was continuing to patch a single monolithic file () instead of performing a necessary architectural refactor to a component-based system, leading to a product that was functionally and visually divergent from the web version.</analysis>
